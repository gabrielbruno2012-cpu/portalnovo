<!doctype html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="mobile-topbar">
    <button class="btn btn-secondary" id="btnMenu">Menu</button>
    <div class="small" id="periodLabel">CoelhoLog</div>
    <button class="btn" onclick="logoutEverywhere()">Sair</button>
  </div>



<script>
// Sync admin login -> collaborator login
if (localStorage.getItem('usuario') && !localStorage.getItem('user')) {
    localStorage.setItem('user', localStorage.getItem('usuario'));
}
</script>

<div id="sidebar-container"></div>

<main class="main">
<h2>Recebíveis</h2>
<div class="card" id="lista"></div>
</main>

<script>
fetch('/components/sidebar_colaborador.html')
  .then(r => r.text())
  .then(html => document.getElementById('sidebar-container').innerHTML = html);

// =========================
//   CARREGAR RECEBÍVEIS
// =========================
async function load() {

  const rawUser = localStorage.getItem("user") || localStorage.getItem("usuario");
  if (!rawUser) {
      window.location = "/";
      return;
  }

  const u = JSON.parse(rawUser);

  const hoje = new Date();
  const mes = String(hoje.getMonth() + 1).padStart(2, "0");
  const ano = hoje.getFullYear();

  let recebiveis = [];
  let producoes = [];

  try {
      const [recebiveisRes, producoesRes] = await Promise.all([
        fetch(`/api/recebiveis?user_id=${u.id}`),
        fetch(`/api/producao/colaborador?usuario_id=${u.id}&mes=${mes}&ano=${ano}`)
      ]);

      recebiveis = await recebiveisRes.json();

      let prodJson = await producoesRes.json();
      if (!Array.isArray(prodJson)) prodJson = [];
      producoes = prodJson;

  } catch (e) {
      console.error("Erro ao carregar APIs:", e);
  }

  // Converter produções para formato compatível com recebíveis
  const producoesConvertidas = producoes.map(p => ({
      id: "P-" + p.id,
      data: p.data,
      valor: p.total_calculado || 0,
      tipo: "Produção",
      status: p.nota_status || "pendente"
  }));

  const todos = [...recebiveis, ...producoesConvertidas];

  if (todos.length === 0) {
      document.getElementById("lista").innerHTML = 
        '<p class="small">Nenhum recebível encontrado.</p>';
      return;
  }

  let html = `
    <table class="table">
      <tr>
        <th>ID</th>
        <th>Data</th>
        <th>Valor</th>
        <th>Tipo</th>
        <th>Status</th>
      </tr>
  `;

  todos.forEach(r => {
      html += `
      <tr>
        <td>${r.id}</td>
        <td>${r.data}</td>
        <td>R$ ${Number(r.valor).toFixed(2)}</td>
        <td>${r.tipo}</td>
        <td>${r.status}</td>
      </tr>
      `;
  });

  html += "</table>";

  document.getElementById("lista").innerHTML = html;
}

document.addEventListener("DOMContentLoaded", load);

  // Toggle sidebar mobile
  document.getElementById('btnMenu')?.addEventListener('click', () => {
    const sb = document.getElementById('sidebar');
    if (sb) sb.classList.toggle('open');
  });

</script>

</body>
</html>
