<html>
<head>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<script>
const uStr = localStorage.getItem("usuario");
let u = null;
try { u = uStr ? JSON.parse(uStr) : null; } catch(e){ u = null; }

if (!u) {
  window.location.href = "/";
} else if (u.role !== "financeiro" && u.role !== "admin") {
  window.location.href = "/colaborador/dashboard.html";
}
</script>


<script>
// Prote√ß√£o de acesso
if (!localStorage.getItem("usuario")) location.href = "/";
</script>

<div id="sidebar"></div>

<div class="main">
    <div class="header-right">
        <button class="btn" onclick="localStorage.clear();location='/'">Logout</button>
    </div>

    <h1>Alterar Empr√©stimos</h1>

    <table class="table" id="lista"></table>
</div>

<script>
// Carregar sidebar
fetch('/admin/sidebar_admin.html')
    .then(r => r.text())
    .then(h => sidebar.innerHTML = h);

// Formata√ß√£o de moeda
function fmt(n) {
    return "R$ " + Number(n || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2 });
}

async function load() {
    let emp = await fetch('/api/emprestimos').then(r => r.json());

    // Mostrar somente empr√©stimos ainda em an√°lise ou aprovados
    emp = emp.filter(e => e.status == "Em an√°lise" || e.status == "Aprovado");

    let html = `
        <tr>
            <th>ID</th>
            <th>Usu√°rio</th>
            <th>Valor</th>
            <th>Parcelas</th>
            <th>Status</th>
            <th>A√ß√£o</th>
        </tr>
    `;

    emp.forEach(e => {
        html += `
            <tr id="row${e.id}">
                <input type="hidden" id="row_uid${e.id}" value="${e.usuario_id}">

                <td>${e.id}</td>
                <td>${e.nome}</td>

                <td>
                    <input type="number" step="0.01" class="input" id="valor${e.id}" value="${e.valor}">
                </td>

                <td>
                    <input type="number" min="1" class="input" id="parc${e.id}" value="${e.parcelamentos}">
                </td>

                <td>
                    <select id="st${e.id}" class="input">
                        <option ${e.status == "Em an√°lise" ? "selected" : ""}>Em an√°lise</option>
                        <option ${e.status == "Aprovado" ? "selected" : ""}>Aprovado</option>
                        <option ${e.status == "Pago" ? "selected" : ""}>Pago</option>
                        <option ${e.status == "Negado" ? "selected" : ""}>Negado</option>
                    </select>
                </td>

                <td>
                    <button class="btn" onclick="save(${e.id})">Salvar</button>
                </td>
            </tr>
        `;
    });

    lista.innerHTML = html;
}

async function save(id) {
    let valor = document.getElementById("valor" + id).value;
    let parcelamentos = document.getElementById("parc" + id).value;
    let status = document.getElementById("st" + id).value;
    let usuario_id = document.getElementById("row_uid" + id).value;

    // Atualiza empr√©stimo
    const res = await fetch("/api/emprestimos/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ valor, parcelamentos, status })
    });

    if (!res.ok) {
        alert("Erro ao atualizar!");
        return;
    }

    // üîµ Status "Aprovado" ‚Üí n√£o some da tabela
    if (status === "Aprovado") {
        alert("Empr√©stimo aprovado!");
        return;
    }

    // üîµ Status "Pago" ‚Üí subir como receb√≠vel
    if (status === "Pago") {

        await fetch("/api/recebiveis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                usuario_id: usuario_id,
                valor: valor,
                tipo: "Empr√©stimo",
                status: "Pendente"
            })
        });

        // Remove da tabela sem recarregar p√°gina
        const tr = document.getElementById("row" + id);
        if (tr) tr.remove();

        alert("Empr√©stimo pago e lan√ßado nos receb√≠veis!");
    }

    // Negado ‚Üí apenas mant√©m e mostra mensagem
    if (status === "Negado") {
        alert("Empr√©stimo negado!");
    }
}

load();
</script>

</body>
</html>
