<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Lançar Produção - CoelhoLog</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: 'Segoe UI', sans-serif;
      background: #062447;
      color: white;
    }

    /* TOPBAR */
    .topbar {
      width: 100%;
      height: 65px;
      background: #002855;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 25px;
      box-sizing: border-box;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 20;
    }

    .topbar img {
      height: 42px;
    }

    .btn-logout {
      background: #f7c600;
      border: none;
      padding: 10px 22px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* SIDEBAR */
    #sidebar {
      width: 240px;
      background: #032040;
      height: 100vh;
      position: fixed;
      top: 65px;
      left: 0;
      overflow-y: auto;
    }

    /* MAIN */
    .main {
      margin-left: 240px;
      width: calc(100% - 240px);
      padding: 100px 40px 40px 40px;
      box-sizing: border-box;
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 26px;
      font-weight: 700;
    }

    .card {
      background: #ffffff18;
      backdrop-filter: blur(6px);
      border-radius: 12px;
      padding: 30px;
      max-width: 750px;
    }

    .input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 18px;
      border-radius: 6px;
      border: 1px solid #ffffff55;
      background: #ffffff15;
      color: white;
      font-size: 15px;
    }

    .input::placeholder {
      color: #ccc;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row .col {
      flex: 1;
    }

    .btn {
      background: #f7c600;
      border: none;
      padding: 12px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 15px;
    }

    #msgProducao {
      margin-top: 12px;
      font-weight: 600;
    }

    .total-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #ffffff22;
      font-weight: 600;
      font-size: 16px;
    }

    .small-hint {
      font-size: 12px;
      opacity: .7;
      margin-top: -10px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <!-- TOPBAR -->
  <div class="topbar">
    <img src="/img/logo.png" alt="CoelhoLog">
    <button class="btn-logout" onclick="logout()">Logout</button>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar"></div>

  <!-- MAIN -->
  <div class="main">
    <h1>Lançar Produção</h1>

    <div class="card">
      <form id="formProducao">

        <label>Colaborador</label>
        <select class="input" id="colaborador"></select>

        <label>Data</label>
        <input class="input" id="data" type="date">

        <div class="row">
          <div class="col">
            <label>Entregas realizadas (total do dia)</label>
            <input class="input" id="entregas" type="number" min="0" placeholder="Quantidade total">
          </div>
          <div class="col">
            <label>Valor por entrega normal (R$)</label>
            <input class="input" id="valor_entrega" type="number" step="0.01" min="0" placeholder="Ex: 1.40">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Produção F simples (qtd)</label>
            <input class="input" id="fs_qtd" type="number" min="0" placeholder="Qtd F simples">
          </div>
          <div class="col">
            <label>Valor F simples (R$)</label>
            <input class="input" id="fs_valor" type="number" step="0.01" min="0" placeholder="Ex: 0.50">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Produção bobina (qtd)</label>
            <input class="input" id="bob_qtd" type="number" min="0" placeholder="Qtd bobina">
          </div>
          <div class="col">
            <label>Valor bobina (R$)</label>
            <input class="input" id="bob_valor" type="number" step="0.01" min="0" placeholder="Ex: 3.00">
          </div>
        </div>

        <p class="small-hint">
          Entregas normais = Entregas realizadas − (F simples + Bobina)
        </p>

        <div class="row">
          <div class="col">
            <label>Fixo diária (R$)</label>
            <input class="input" id="fixo" type="number" step="0.01" min="0" placeholder="Ex: 250.00">
          </div>
          <div class="col">
            <label>Desconto (R$)</label>
            <input class="input" id="desconto" type="number" step="0.01" min="0" placeholder="Ex: 120.00">
          </div>
        </div>

        <div class="row" id="emprestimoBox" style="display:none; align-items:flex-end;">
          <div class="col">
            <label>Empréstimo</label>
            <div class="input" style="display:flex; flex-direction:column; gap:6px;">
              <div id="emprestimoInfo" style="font-weight:700;">—</div>
              <div style="font-size:12px; opacity:.85;">Se marcar “Sim”, o sistema aplica a próxima parcela automaticamente.</div>
            </div>
          </div>
          <div class="col">
            <label>Aplicar desconto do empréstimo nesta produção</label>
            <select class="input" id="aplicar_emprestimo">
              <option value="nao">Não</option>
              <option value="sim">Sim (descontar próxima parcela)</option>
            </select>
          </div>
        </div>


        <label>Observações</label>
        <textarea class="input" id="obs" placeholder="Observações (opcional)" rows="3"></textarea>

        <div class="total-box">
          Total calculado: <span id="total_calculado">R$ 0,00</span>
        </div>

        <button type="submit" class="btn">Lançar Produção</button>
        <div id="msgProducao"></div>
      </form>
    </div>
  </div>

  <script>
    // ===== PROTEÇÃO / LOGIN =====
    const uStr = localStorage.getItem("usuario");
    let user = null;
    try { user = uStr ? JSON.parse(uStr) : null; } catch (e) { user = null; }

    if (!user) {
      window.location.href = "/";
    } else if (user.role !== "financeiro" && user.role !== "admin") {
      // se não for admin nem financeiro, manda para painel de colaborador
      window.location.href = "/colaborador/demonstrativo.html";
    }

    // ===== SIDEBAR ADMIN =====
    fetch('/admin/sidebar_admin.html')
      .then(r => r.text())
      .then(h => sidebar.innerHTML = h);

    // ===== LOGOUT =====
    function logout() {
      localStorage.clear();
      location = "/";
    }

    // ===== CARREGAR COLABORADORES =====
    async function loadUsers() {
      try {
        const resp = await fetch('/api/usuarios');
        const users = await resp.json();
        const onlyColab = users; // se quiser filtrar por role === 'colaborador', pode filtrar aqui

        colaborador.innerHTML = onlyColab.map(x => `
          <option value="${x.id}">${x.nome}</option>
        `).join('');
      } catch (e) {
        console.error("Erro ao carregar usuários:", e);
      }
    }
    loadUsers();


    // ===== EMPRÉSTIMO (desconto automático por parcela) =====
    const emprestimoBox = document.getElementById('emprestimoBox');
    const emprestimoInfo = document.getElementById('emprestimoInfo');
    const aplicarEmprestimoSelect = document.getElementById('aplicar_emprestimo');

    let emprestimoAtual = null; // { valor_parcela, rotulo, ... }

    async function carregarEmprestimoPendente() {
      emprestimoAtual = null;
      if (!colaborador || !colaborador.value) {
        if (emprestimoBox) emprestimoBox.style.display = 'none';
        if (aplicarEmprestimoSelect) aplicarEmprestimoSelect.value = 'nao';
        return;
      }

      try {
        const usuarioId = Number(colaborador.value || 0);
        const resp = await fetch(`/api/emprestimos/pendente?usuario_id=${usuarioId}`);
        const data = await resp.json();

        if (data && data.tem) {
          emprestimoAtual = data;
          if (emprestimoBox) emprestimoBox.style.display = 'flex';
          if (emprestimoInfo) {
            emprestimoInfo.textContent = `${data.rotulo} — Parcela: R$ ${Number(data.valor_parcela).toFixed(2)}`;
          }
        } else {
          if (emprestimoBox) emprestimoBox.style.display = 'none';
          if (aplicarEmprestimoSelect) aplicarEmprestimoSelect.value = 'nao';
        }

      } catch (e) {
        console.error('Erro ao carregar empréstimo pendente', e);
        if (emprestimoBox) emprestimoBox.style.display = 'none';
        if (aplicarEmprestimoSelect) aplicarEmprestimoSelect.value = 'nao';
      }
    }

    // quando troca colaborador
    if (colaborador) {
      colaborador.addEventListener('change', async () => {
        await carregarEmprestimoPendente();
        // se o admin já deixou marcado "sim", recalcula desconto
        if (aplicarEmprestimoSelect && aplicarEmprestimoSelect.value === 'sim' && emprestimoAtual) {
          descontoInput.value = Number(emprestimoAtual.valor_parcela || 0).toFixed(2);
          calcularTotal();
        }
      });
    }

    // quando admin escolhe aplicar ou não
    if (aplicarEmprestimoSelect) {
      aplicarEmprestimoSelect.addEventListener('change', () => {
        if (aplicarEmprestimoSelect.value === 'sim') {
          if (!emprestimoAtual) {
            // não tem empréstimo aprovado pendente
            aplicarEmprestimoSelect.value = 'nao';
            alert('Este colaborador não possui empréstimo aprovado pendente.');
            return;
          }
          // desconto automático = valor integral da parcela
          descontoInput.value = Number(emprestimoAtual.valor_parcela || 0).toFixed(2);
        }
        calcularTotal();
      });
    }


    // ===== FUNÇÕES DE CÁLCULO =====
    const entregasInput = document.getElementById("entregas");
    const valorEntregaInput = document.getElementById("valor_entrega");
    const fsQtdInput = document.getElementById("fs_qtd");
    const fsValInput = document.getElementById("fs_valor");
    const bobQtdInput = document.getElementById("bob_qtd");
    const bobValInput = document.getElementById("bob_valor");
    const fixoInput = document.getElementById("fixo");
    const descontoInput = document.getElementById("desconto");
    const totalSpan = document.getElementById("total_calculado");
    const msgSpan = document.getElementById("msgProducao");
    const form = document.getElementById("formProducao");
    const dataInput = document.getElementById("data");
    const obsInput = document.getElementById("obs");

    function toNumber(el) {
      if (!el) return 0;
      return Number((el.value || "0").replace(",", "."));
    }

    function formatBRL(v) {
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function calcularTotal() {
      const entregas = toNumber(entregasInput);
      const valorEntrega = toNumber(valorEntregaInput);

      const fsQtd = toNumber(fsQtdInput);
      const fsVal = toNumber(fsValInput);

      const bobQtd = toNumber(bobQtdInput);
      const bobVal = toNumber(bobValInput);

      const fixo = toNumber(fixoInput);
      const desconto = toNumber(descontoInput);

      // ENTREGAS NORMAIS = total - (FS + Bobina)
      const entregasNormais = Math.max(0, entregas - (fsQtd + bobQtd));

      const totalEntregasNormais = entregasNormais * valorEntrega;
      const totalFs = fsQtd * fsVal;
      const totalBob = bobQtd * bobVal;

      const total = totalEntregasNormais + totalFs + totalBob + fixo - desconto;

      totalSpan.textContent = formatBRL(total);

      return {
        entregas,
        valorEntrega,
        fsQtd,
        fsVal,
        bobQtd,
        bobVal,
        fixo,
        desconto,
        total
      };
    }

    [
      entregasInput, valorEntregaInput,
      fsQtdInput, fsValInput,
      bobQtdInput, bobValInput,
      fixoInput, descontoInput
    ].forEach(el => {
      if (!el) return;
      el.addEventListener("input", calcularTotal);
      el.addEventListener("change", calcularTotal);
    });

    calcularTotal();

    // ===== SUBMIT DO FORMULÁRIO =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgSpan.textContent = "";
      msgSpan.style.color = "#fff";

      const usuario_id = Number(colaborador.value || 0);
      if (!usuario_id) {
        msgSpan.textContent = "Selecione um colaborador.";
        msgSpan.style.color = "red";
        return;
      }

      const data = dataInput.value;
      if (!data) {
        msgSpan.textContent = "Informe a data.";
        msgSpan.style.color = "red";
        return;
      }

      const valores = calcularTotal();

      const body = {
        usuario_id: usuario_id,
        data: data,
        entregas: valores.entregas,
        valor_por_entrega: valores.valorEntrega,
        producao_fs: valores.fsQtd,
        valor_fs: valores.fsVal,
        producao_bobina: valores.bobQtd,
        valor_bobina: valores.bobVal,
        fixo_diaria: valores.fixo,
        desconto: valores.desconto,
        total_calculado: valores.total,
        obs: obsInput ? obsInput.value : "",
        aplicar_desconto_emprestimo: (aplicarEmprestimoSelect && aplicarEmprestimoSelect.value === "sim")
      };

      try {
        const resp = await fetch("/api/producao", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          throw new Error("Erro ao salvar produção");
        }

        msgSpan.textContent = "Produção lançada com sucesso!";
        msgSpan.style.color = "#00ffae";
      } catch (err) {
        console.error(err);
        msgSpan.textContent = "Erro ao salvar produção.";
        msgSpan.style.color = "red";
      }
    });
  </script>

</body>
</html>
