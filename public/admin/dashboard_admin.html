<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo - CoelhoLog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/ui-common.js"></script>
  <script src="/js/dashboard-widgets.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="mobile-topbar">
    <button class="btn btn-secondary" id="btnMenu">Menu</button>
    <div class="small" id="periodLabel">Admin</div>
    <button class="btn" onclick="logoutEverywhere()">Sair</button>
  </div>

  <div id="sidebar-container"></div>

  <main class="main">
    <div class="header-right">
      <button class="btn" onclick="logoutEverywhere()">Logout</button>
    </div>

    <h1>Painel Administrativo</h1>

    <div class="card">
      <div class="filter-bar">
        <div class="field">
          <div class="small">Período</div>
          <select class="input" id="fPeriod"></select>
        </div>
        <div class="field">
          <div class="small">Status</div>
          <select class="input" id="fStatus">
            <option value="all">Todos</option>
            <option value="ok">Pago/Aprovado</option>
            <option value="pendente">Pendente</option>
            <option value="processando">Em processamento</option>
            <option value="negado">Recusado</option>
          </select>
        </div>
        <div class="field">
          <div class="small">Tipo</div>
          <select class="input" id="fType">
            <option value="all">Todos</option>
            <option value="recebivel">Recebível</option>
            <option value="producao">Produção</option>
            <option value="emprestimo">Empréstimo</option>
          </select>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn" id="btnApply">Aplicar</button>
          <button class="btn btn-secondary" id="btnClear">Limpar</button>
        </div>
      </div>
      <div class="small" id="activeFilters"></div>
    </div>

    <div class="top-cards" id="kpis">
      <div class="top-card card kpi-card" data-kpi="pendente" title="Clique para filtrar pendentes">
        <div class="small">Recebíveis Pendentes</div>
        <div id="kpi_pendente" class="huge">R$ 0,00</div>
      </div>

      <div class="top-card card kpi-card" data-kpi="ok" title="Clique para filtrar pagos/aprovados">
        <div class="small">Recebíveis Pagos/Aprovados</div>
        <div id="kpi_ok" class="huge">R$ 0,00</div>
      </div>

      <div class="top-card card kpi-card" data-kpi="processando" title="Clique para filtrar em processamento">
        <div class="small">Em Processamento</div>
        <div id="kpi_proc" class="huge">R$ 0,00</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h3 style="margin:0;">Recebíveis pagos (por dia)</h3>
        <button class="btn btn-secondary" id="btnExport">Exportar CSV</button>
      </div>
      <div style="height:260px; margin-top:10px;">
        <canvas id="barChart"></canvas>
      </div>
      <div class="small" style="margin-top:8px;">Dica: clique em uma barra do gráfico para filtrar a tabela por dia</div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h3 style="margin:0;">Últimos lançamentos</h3>
        <div class="small" id="tableHint">Clique numa linha para ver detalhes</div>
      </div>
      <div id="recList" style="margin-top:10px;"></div>
    </div>

  </main>

<script>
  const adminUser = enforceAuthOrRedirect(['financeiro','admin']);

  fetch('/components/sidebar_admin_collapsible.html')
    .then(r => r.text())
    .then(html => document.getElementById('sidebar-container').innerHTML = html);

  document.getElementById('btnMenu').addEventListener('click', () => {
    const sb = document.getElementById('sidebar');
    if (sb) sb.classList.toggle('open');
  });

  window._barChart = null;
  let _rowsAll = [];

  function currentFilters() {
    return {
      period: document.getElementById('fPeriod').value,
      status: document.getElementById('fStatus').value,
      type: document.getElementById('fType').value,
    };
  }

  function buildActiveFiltersText(filters) {
    const parts = [];
    if (filters.period && filters.period !== 'all') {
      const [y, m] = filters.period.split('-');
      parts.push(`Período: ${monthLabel(m)}/${y}`);
    }
    if (filters.status && filters.status !== 'all') {
      const map = { ok: 'Pago/Aprovado', pendente: 'Pendente', processando: 'Em processamento', negado: 'Recusado' };
      parts.push(`Status: ${map[filters.status] || filters.status}`);
    }
    if (filters.type && filters.type !== 'all') {
      const typeMap = {recebivel:'Recebível', producao:'Produção', emprestimo:'Empréstimo'}; parts.push(`Tipo: ${typeMap[filters.type] || filters.type}`);
    }
    return parts.length ? 'Filtros ativos: ' + parts.join(' · ') : 'Filtros ativos: nenhum';
  }

  function applyAndRender() {
    const filters = currentFilters();
    document.getElementById('activeFilters').textContent = buildActiveFiltersText(filters);

    const [y, m] = String(filters.period || '').split('-');
    document.getElementById('periodLabel').textContent = (y && m) ? `${monthLabel(m)}/${y}` : 'Admin';

    const filtered = rowsApplyFilters(_rowsAll, filters);

    const k = computeKpis(filtered);
    document.getElementById('kpi_ok').textContent = fmtBRL(k.totalOk);
    document.getElementById('kpi_pendente').textContent = fmtBRL(k.totalPend);
    document.getElementById('kpi_proc').textContent = fmtBRL(k.totalProc);

    const recList = document.getElementById('recList');
    renderTable(recList, filtered.slice(0, 80), { showUser: true });
    attachRowClick(recList, filtered.slice(0, 80));

    const chartData = groupPaidByDay(_rowsAll, filters.period);
    const ctx = document.getElementById('barChart').getContext('2d');
    if (window._barChart) window._barChart.destroy();

    window._barChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Recebíveis pagos (R$)',
          data: chartData.values,
          backgroundColor: '#F6C21B',
          borderRadius: 8,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => fmtBRL(ctx.parsed.y) } }
        },
        scales: { y: { beginAtZero: true, ticks: { callback: (v) => 'R$ ' + v } } },
        onClick: (_evt, elements) => {
          if (!elements || !elements.length) return;
          const idx = elements[0].index;
          const dayLabel = chartData.labels[idx];
          const f = currentFilters();
          const dayFiltered = rowsApplyFilters(_rowsAll, f).filter(r => {
            const d = parseISODateOnly(r.data);
            return d && String(d.day).padStart(2,'0') === dayLabel;
          });
          renderTable(recList, dayFiltered.slice(0, 200), { showUser: true });
          attachRowClick(recList, dayFiltered.slice(0, 200));
          document.getElementById('tableHint').textContent = `Filtrado pelo dia ${dayLabel}`;
        }
      }
    });

    document.getElementById('tableHint').textContent = 'Clique numa linha para ver detalhes';
  }

  async function loadAdminDashboard() {
    if (!adminUser) return;

    buildMonthYearOptions(document.getElementById('fPeriod'));

    let recebiveis = [];
    let producoes = [];
    let emprestimos = [];

    try {
      const [r1, r2, r3] = await Promise.all([
        fetch('/api/recebiveis'),
        fetch('/api/producao/admin'),
        fetch('/api/emprestimos')
      ]);
      recebiveis = await r1.json();
      producoes = await r2.json();
      emprestimos = await r3.json();
    } catch (e) {
      console.error('Erro ao carregar dados:', e);
    }

    // Consolidar tudo em _rowsAll com tipo
    const recRows = (Array.isArray(recebiveis) ? recebiveis : []).map(r => ({
      ...r,
      tipo: 'Recebível',
      data: r.data || '',
      valor: Number(r.valor || 0),
      status: r.status || 'Pendente',
      nome: r.nome || ''
    }));

    const prodRows = (Array.isArray(producoes) ? producoes : []).map(p => ({
      id: p.id,
      usuario_id: p.usuario_id,
      nome: p.colaborador || '',
      data: p.data || '',
      valor: Number(p.total_calculado || 0),
      tipo: 'Produção',
      status: p.nota_status === 'aprovado' ? 'ok' : (p.nota_status === 'pendente' ? 'pendente' : 'processando'),
      obs: p.obs || ''
    }));

    const empRows = (Array.isArray(emprestimos) ? emprestimos : []).map(e => ({
      id: e.id,
      usuario_id: e.usuario_id,
      nome: e.nome || '',
      data: e.criado_em || '',
      valor: Number(e.valor || 0),
      tipo: 'Empréstimo',
      status: e.status === 'Aprovado' ? 'ok' : (e.status === 'Em análise' ? 'pendente' : 'negado'),
      obs: `${e.parcelamentos || 0}x`
    }));

    _rowsAll = [...recRows, ...prodRows, ...empRows];

    document.getElementById('btnApply').addEventListener('click', applyAndRender);
    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('fStatus').value = 'all';
      document.getElementById('fType').value = 'all';
      applyAndRender();
    });

    document.getElementById('kpis').addEventListener('click', (ev) => {
      const card = ev.target.closest('[data-kpi]');
      if (!card) return;
      const key = card.getAttribute('data-kpi');
      document.getElementById('fStatus').value = key;
      kpiSetActive(document.getElementById('kpis'), key);
      applyAndRender();
    });

    document.getElementById('btnExport').addEventListener('click', () => {
      const filters = currentFilters();
      const filtered = rowsApplyFilters(_rowsAll, filters);
      const safe = filtered.map(r => ({
        id: r.id,
        usuario: r.nome || '',
        data: (r.data || '').split(' ')[0],
        valor: Number(r.valor || 0),
        tipo: r.tipo || '',
        status: r.status || ''
      }));
      const [y, m] = (filters.period || 'periodo').split('-');
      downloadCSV(`admin_dashboard_${y||''}${m||''}.csv`, safe);
    });

    applyAndRender();
  }

  document.addEventListener('DOMContentLoaded', loadAdminDashboard);
</script>
</body>
</html>
